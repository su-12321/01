<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>烟花 · 点击互动</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #0a0f1e;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 10;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        (function() {
            "use strict";

            // ------------------- 烟花增强类 ---------------------------
            var FireworksEnhanced = function(canvasElem) {
                var self = this;

                // 工具函数
                var rand = function(rMi, rMa) {
                    return ~~(Math.random() * (rMa - rMi + 1) + rMi);
                };

                var hitTest = function(x1, y1, w1, h1, x2, y2, w2, h2) {
                    return !(x1 + w1 < x2 || x2 + w2 < x1 || y1 + h1 < y2 || y2 + h2 < y1);
                };

                window.requestAnimFrame = (function() {
                    return window.requestAnimationFrame ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function(callback) { window.setTimeout(callback, 1000 / 60); };
                })();

                // ------ 音频引擎 (使用Web Audio合成爆炸声) ------
                let audioCtx = null;
                let isAudioReady = false;

                function initAudio() {
                    if (audioCtx) return;
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        isAudioReady = true;
                    } catch (e) {
                        console.warn("Web Audio not supported");
                    }
                }

                // 播放烟花爆炸声 (合成短噪声)
                function playExplodeSound() {
                    if (!audioCtx || !isAudioReady) return;
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume().then(() => {
                            doPlay();
                        }).catch(() => {});
                    } else if (audioCtx.state === 'running') {
                        doPlay();
                    }

                    function doPlay() {
                        const now = audioCtx.currentTime;
                        const gainNode = audioCtx.createGain();
                        gainNode.connect(audioCtx.destination);

                        const bufferSize = 4096;
                        const noiseNode = audioCtx.createScriptProcessor(bufferSize, 1, 1);
                        noiseNode.onaudioprocess = function(e) {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                        };
                        noiseNode.connect(gainNode);

                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.25);

                        noiseNode.stop = function() {
                            noiseNode.disconnect();
                            gainNode.disconnect();
                        };
                        setTimeout(() => { noiseNode.stop(); }, 300);
                    }
                }

                // ----- 增强物理参数 ----
                self.init = function() {
                    self.canvas = canvasElem;
                    self.ctx = self.canvas.getContext('2d');
                    self.resizeCanvas();

                    self.particles = [];
                    self.fireworks = [];
                    self.mx = self.cw / 2;
                    self.my = self.ch / 2;

                    self.currentHue = rand(20, 50);

                    self.partCount = 200;
                    self.partSpeed = 7;
                    self.partSpeedVariance = 14;
                    self.partWind = 30;
                    self.partFriction = 3;
                    self.partGravity = 0.8;
                    self.hueMin = 0;
                    self.hueMax = 360;
                    self.fworkSpeed = 5;
                    self.fworkAccel = 9;
                    self.hueVariance = 45;
                    self.flickerDensity = 35;
                    self.showShockwave = true;
                    self.showTarget = false;
                    self.clearAlpha = 18;

                    self.lineWidth = 1.8;

                    self.bindEvents();
                    self.canvasLoop();

                    self.canvas.onselectstart = function() { return false; };
                };

                self.resizeCanvas = function() {
                    self.cw = window.innerWidth;
                    self.ch = window.innerHeight;
                    self.canvas.width = self.cw;
                    self.canvas.height = self.ch;
                    self.ctx.lineCap = 'round';
                    self.ctx.lineJoin = 'round';
                    self.ctx.lineWidth = self.lineWidth;
                };

                self.createParticles = function(x, y, hue) {
                    playExplodeSound();

                    var count = self.partCount;
                    while (count--) {
                        var speed = rand(
                            Math.max(1, self.partSpeed - self.partSpeedVariance),
                            self.partSpeed + self.partSpeedVariance
                        );
                        var newParticle = {
                            x: x,
                            y: y,
                            coordLast: [
                                { x: x, y: y },
                                { x: x, y: y },
                                { x: x, y: y }
                            ],
                            angle: rand(0, 360),
                            speed: speed,
                            friction: 1 - self.partFriction / 100,
                            gravity: self.partGravity / 2 + (Math.random() * 0.2 - 0.1),
                            hue: rand(hue - self.hueVariance, hue + self.hueVariance),
                            brightness: rand(70, 100),
                            alpha: rand(60, 100) / 100,
                            decay: rand(5, 25) / 1000,
                            wind: (rand(0, self.partWind) - self.partWind / 2) / 25,
                            lineWidth: self.lineWidth * rand(8, 15) / 10,
                            radius: rand(1, 3)
                        };
                        self.particles.push(newParticle);
                    }
                };

                self.updateParticles = function() {
                    var i = self.particles.length;
                    while (i--) {
                        var p = self.particles[i];
                        var radians = (p.angle * Math.PI) / 180;
                        var vx = Math.cos(radians) * p.speed;
                        var vy = Math.sin(radians) * p.speed;
                        p.speed *= p.friction;

                        p.coordLast[2].x = p.coordLast[1].x;
                        p.coordLast[2].y = p.coordLast[1].y;
                        p.coordLast[1].x = p.coordLast[0].x;
                        p.coordLast[1].y = p.coordLast[0].y;
                        p.coordLast[0].x = p.x;
                        p.coordLast[0].y = p.y;

                        p.x += vx;
                        p.y += vy;
                        p.y += p.gravity;
                        p.angle += p.wind;
                        p.alpha -= p.decay;

                        if (p.x < 0 || p.x > self.cw) {
                            p.angle = 180 - p.angle;
                            if (p.x < 0) p.x = 2;
                            if (p.x > self.cw) p.x = self.cw - 2;
                            p.speed *= 0.6;
                        }
                        if (p.y < 0 || p.y > self.ch) {
                            p.angle = -p.angle;
                            if (p.y < 0) p.y = 2;
                            if (p.y > self.ch) p.y = self.ch - 2;
                            p.speed *= 0.6;
                        }

                        if (p.alpha < 0.01) {
                            self.particles.splice(i, 1);
                        }
                    }
                };

                self.drawParticles = function() {
                    var i = self.particles.length;
                    while (i--) {
                        var p = self.particles[i];
                        var coordRand = rand(0, 2);
                        self.ctx.beginPath();
                        self.ctx.moveTo(
                            Math.round(p.coordLast[coordRand].x),
                            Math.round(p.coordLast[coordRand].y)
                        );
                        self.ctx.lineTo(Math.round(p.x), Math.round(p.y));
                        self.ctx.closePath();
                        self.ctx.strokeStyle = `hsla(${p.hue}, 100%, ${p.brightness}%, ${p.alpha})`;
                        self.ctx.stroke();

                        if (self.flickerDensity > 0) {
                            var inverseDensity = 60 - self.flickerDensity;
                            if (rand(0, inverseDensity) === 0) {
                                self.ctx.beginPath();
                                self.ctx.arc(Math.round(p.x), Math.round(p.y), rand(1, 3), 0, 2 * Math.PI);
                                self.ctx.closePath();
                                var randAlpha = rand(50, 100) / 100;
                                self.ctx.fillStyle = `hsla(${p.hue}, 100%, ${p.brightness}%, ${randAlpha})`;
                                self.ctx.fill();
                            }
                        }
                    }
                };

                self.createFireworks = function(startX, startY, targetX, targetY) {
                    var angle = Math.atan2(targetY - startY, targetX - startX);
                    var newFirework = {
                        x: startX,
                        y: startY,
                        startX: startX,
                        startY: startY,
                        hitX: false,
                        hitY: false,
                        coordLast: [
                            { x: startX, y: startY },
                            { x: startX, y: startY },
                            { x: startX, y: startY }
                        ],
                        targetX: targetX,
                        targetY: targetY,
                        speed: self.fworkSpeed,
                        angle: angle,
                        shockwaveAngle: angle + 90 * (Math.PI / 180),
                        acceleration: self.fworkAccel / 100,
                        hue: self.currentHue,
                        brightness: rand(70, 100),
                        alpha: rand(70, 100) / 100,
                        lineWidth: self.lineWidth
                    };
                    self.fireworks.push(newFirework);
                };

                self.updateFireworks = function() {
                    var i = self.fireworks.length;
                    while (i--) {
                        var f = self.fireworks[i];
                        var vx = Math.cos(f.angle) * f.speed;
                        var vy = Math.sin(f.angle) * f.speed;
                        f.speed *= 1 + f.acceleration;

                        f.coordLast[2].x = f.coordLast[1].x;
                        f.coordLast[2].y = f.coordLast[1].y;
                        f.coordLast[1].x = f.coordLast[0].x;
                        f.coordLast[1].y = f.coordLast[0].y;
                        f.coordLast[0].x = f.x;
                        f.coordLast[0].y = f.y;

                        if (f.startX >= f.targetX) {
                            if (f.x + vx <= f.targetX) { f.x = f.targetX; f.hitX = true; }
                            else { f.x += vx; }
                        } else {
                            if (f.x + vx >= f.targetX) { f.x = f.targetX; f.hitX = true; }
                            else { f.x += vx; }
                        }

                        if (f.startY >= f.targetY) {
                            if (f.y + vy <= f.targetY) { f.y = f.targetY; f.hitY = true; }
                            else { f.y += vy; }
                        } else {
                            if (f.y + vy >= f.targetY) { f.y = f.targetY; f.hitY = true; }
                            else { f.y += vy; }
                        }

                        if (f.hitX && f.hitY) {
                            self.createParticles(f.targetX, f.targetY, f.hue);
                            self.fireworks.splice(i, 1);
                        }
                    }
                };

                self.drawFireworks = function() {
                    var i = self.fireworks.length;
                    self.ctx.globalCompositeOperation = 'lighter';
                    while (i--) {
                        var f = self.fireworks[i];
                        var coordRand = rand(0, 2);
                        self.ctx.beginPath();
                        self.ctx.moveTo(
                            Math.round(f.coordLast[coordRand].x),
                            Math.round(f.coordLast[coordRand].y)
                        );
                        self.ctx.lineTo(Math.round(f.x), Math.round(f.y));
                        self.ctx.closePath();
                        self.ctx.strokeStyle = `hsla(${f.hue}, 100%, ${f.brightness}%, ${f.alpha})`;
                        self.ctx.stroke();

                        if (self.showShockwave) {
                            self.ctx.save();
                            self.ctx.translate(Math.round(f.x), Math.round(f.y));
                            self.ctx.rotate(f.shockwaveAngle);
                            self.ctx.beginPath();
                            self.ctx.arc(0, 0, 1 * (f.speed / 4), 0, Math.PI, true);
                            self.ctx.strokeStyle = `hsla(${f.hue}, 100%, ${f.brightness}%, ${rand(20, 50) / 100})`;
                            self.ctx.lineWidth = f.lineWidth;
                            self.ctx.stroke();
                            self.ctx.restore();
                        }
                    }
                    self.ctx.globalCompositeOperation = 'source-over';
                };

                self.bindEvents = function() {
                    $(window).on('resize', function() {
                        clearTimeout(self.resizeTimeout);
                        self.resizeTimeout = setTimeout(function() { self.resizeCanvas(); }, 100);
                    });

                    function handleStart(e) {
                        e.preventDefault();
                        initAudio();
                        if (audioCtx && audioCtx.state === 'suspended') {
                            audioCtx.resume();
                        }

                        var clientX, clientY;
                        if (e.type === 'mousedown') {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        } else {
                            if (e.touches.length > 0) {
                                clientX = e.touches[0].clientX;
                                clientY = e.touches[0].clientY;
                            } else return;
                        }

                        self.mx = clientX;
                        self.my = clientY;
                        self.currentHue = rand(self.hueMin, self.hueMax);
                        self.createFireworks(self.cw / 2, self.ch, self.mx, self.my);

                        function handleMove(e) {
                            e.preventDefault();
                            var moveX, moveY;
                            if (e.type === 'mousemove') {
                                moveX = e.clientX;
                                moveY = e.clientY;
                            } else {
                                if (e.touches.length > 0) {
                                    moveX = e.touches[0].clientX;
                                    moveY = e.touches[0].clientY;
                                } else return;
                            }
                            self.mx = moveX;
                            self.my = moveY;
                            self.currentHue = rand(self.hueMin, self.hueMax);
                            self.createFireworks(self.cw / 2, self.ch, self.mx, self.my);
                        }

                        function handleEnd(e) {
                            e.preventDefault();
                            $(self.canvas).off('mousemove touchmove', handleMove);
                            $(self.canvas).off('mouseup touchend touchcancel', handleEnd);
                        }

                        $(self.canvas).on('mousemove touchmove', handleMove);
                        $(self.canvas).on('mouseup touchend touchcancel', handleEnd);
                    }

                    $(self.canvas).on('mousedown touchstart', handleStart);
                    self.canvas.addEventListener('touchstart', function(e) { e.preventDefault(); }, { passive: false });
                    self.canvas.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
                };

                self.canvasLoop = function() {
                    requestAnimFrame(self.canvasLoop, self.canvas);

                    self.ctx.globalCompositeOperation = 'source-over';
                    self.ctx.fillStyle = 'rgba(0, 0, 0, ' + self.clearAlpha / 100 + ')';
                    self.ctx.fillRect(0, 0, self.cw, self.ch);

                    self.updateFireworks();
                    self.updateParticles();
                    self.drawFireworks();
                    self.drawParticles();
                };

                self.init();
            };

            // 启动烟花
            var canvas = document.getElementById('fireworksCanvas');
            var fworks = new FireworksEnhanced(canvas);
            window.fworks = fworks;
        })();
    </script>
</body>
</html>
